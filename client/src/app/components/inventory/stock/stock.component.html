<div class="container-fluid px-0">
  <!-- Header Section -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h3 class="mb-0 text-dark">Stock Management</h3>
    </div>
    <div class="d-flex gap-2">
      <button class="btn" (click)="toggleAutoRefresh()">
        <i class="fas fa-sync-alt me-1" [class.fa-spin]="autoRefresh()"></i>
        Auto-refresh {{ autoRefresh() ? "ON" : "OFF" }}
      </button>
      <button class="btn" (click)="refresh()" [disabled]="loading()">
        @if (loading()) {
          <span class="spinner-border spinner-border-sm me-2" role="status">
            <span class="visually-hidden">Loading...</span>
          </span>
          Refreshing...
        } @else {
          <i class="fas fa-sync-alt me-1"></i> Refresh
        }
      </button>
    </div>
  </div>

  <!-- Error Alert -->
  @if (error()) {
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
      <i class="fas fa-exclamation-triangle me-2"></i>{{ error() }}
      <button
        type="button"
        class="btn-close"
        (click)="error.set(null)"
      ></button>
    </div>
  }

  <!-- Loading State -->
  @if (loading() && allStocks().length === 0) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading stock data...</span>
      </div>
      <p class="mt-3 text-muted">Loading comprehensive stock analysis...</p>
    </div>
  }

  <!-- Main Content -->
  @if (!loading() || allStocks().length > 0) {
    <!-- Navigation Tabs -->
    <ul class="nav nav-pills mb-4" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link"
          [class.active]="selectedView() === 'dashboard'"
          (click)="setView('dashboard')"
        >
          <i class="fas fa-tachometer-alt me-1"></i>Dashboard
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link position-relative"
          [class.active]="selectedView() === 'all'"
          (click)="setView('all')"
        >
          <i class="fas fa-list me-1"></i>All Stocks
          <span class="badge bg-secondary ms-1">{{
            metrics().totalStocks
          }}</span>
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link position-relative"
          [class.active]="selectedView() === 'low'"
          (click)="setView('low')"
        >
          <i class="fas fa-exclamation-circle me-1 text-warning"></i>Low Stock
          @if (metrics().lowStockCount > 0) {
            <span class="badge bg-warning ms-1">{{
              metrics().lowStockCount
            }}</span>
          }
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link position-relative"
          [class.active]="selectedView() === 'zero'"
          (click)="setView('zero')"
        >
          <i class="fas fa-exclamation-triangle me-1 text-danger"></i>Out of
          Stock
          @if (metrics().zeroStockCount > 0) {
            <span class="badge bg-danger ms-1">{{
              metrics().zeroStockCount
            }}</span>
          }
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link position-relative"
          [class.active]="selectedView() === 'over'"
          (click)="setView('over')"
        >
          <i class="fas fa-info-circle me-1 text-info"></i>Overstock
          @if (metrics().overStockCount > 0) {
            <span class="badge bg-info ms-1">{{
              metrics().overStockCount
            }}</span>
          }
        </button>
      </li>
    </ul>

    <!-- Dashboard View -->
    @if (selectedView() === "dashboard") {
      <!-- Key Metrics Cards -->
      <div class="row mb-4">
        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-boxes fa-2x text-primary me-2"></i>
                <h2 class="mb-0 text-primary">{{ metrics().totalStocks }}</h2>
              </div>
              <h6 class="card-title text-muted">Total Stock Items</h6>
              <small class="text-success">
                <i class="fas fa-chart-line me-1"></i>Active inventory
              </small>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <h2 class="mb-0 text-success">
                  {{ formatCurrency(metrics().totalValue) }}
                </h2>
              </div>
              <h6 class="card-title text-muted">Total Inventory Value</h6>
              <small class="text-info">
                <i class="fas fa-calculator me-1"></i>Estimated value
              </small>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i
                  class="fas fa-exclamation-triangle fa-2x text-warning me-2"
                ></i>
                <h2 class="mb-0 text-warning">
                  {{ metrics().criticalAlerts }}
                </h2>
              </div>
              <h6 class="card-title text-muted">Critical Alerts</h6>
              <small class="text-warning">
                <i class="fas fa-bell me-1"></i>Requires attention
              </small>
            </div>
          </div>
        </div>

        <div class="col-md-3 mb-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
              <div
                class="d-flex align-items-center justify-content-center mb-2"
              >
                <i class="fas fa-warehouse fa-2x text-info me-2"></i>
                <h2 class="mb-0 text-info">{{ warehouses().length }}</h2>
              </div>
              <h6 class="card-title text-muted">Active Warehouses</h6>
              <small class="text-info">
                <i class="fas fa-map-marker-alt me-1"></i>Locations
              </small>
            </div>
          </div>
        </div>
      </div>

      <!-- Business Alerts -->
      @if (alerts().length > 0) {
        <div class="card mb-4 border-0 shadow-sm">
          <div class="card-header bg-light">
            <h5 class="mb-0">
              <i class="fas fa-bell me-2 text-warning"></i>Business Alerts &
              Recommendations
            </h5>
          </div>
          <div class="card-body">
            @for (alert of alerts(); track alert.type) {
              <div
                class="alert mb-3"
                [class.alert-danger]="alert.type === 'critical'"
                [class.alert-warning]="alert.type === 'warning'"
                [class.alert-info]="alert.type === 'info'"
              >
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong>
                      @if (alert.type === "critical") {
                        <i class="fas fa-exclamation-triangle me-2"></i>
                      } @else if (alert.type === "warning") {
                        <i class="fas fa-exclamation-circle me-2"></i>
                      } @else {
                        <i class="fas fa-info-circle me-2"></i>
                      }
                      {{ alert.count }} {{ alert.message }}
                    </strong>
                    <div class="mt-1">
                      <small
                        ><strong>Recommended Action:</strong>
                        {{ alert.action }}</small
                      >
                    </div>
                  </div>
                  <div>
                    @if (alert.type === "critical") {
                      <button
                        class="btn btn-danger btn-sm"
                        (click)="setView('zero')"
                      >
                        View Details
                      </button>
                    } @else if (alert.type === "warning") {
                      <button
                        class="btn btn-warning btn-sm"
                        (click)="setView('low')"
                      >
                        View Details
                      </button>
                    } @else {
                      <button
                        class="btn btn-info btn-sm"
                        (click)="setView('over')"
                      >
                        View Details
                      </button>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Quick Stats -->
      <div class="row">
        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="card-title text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>Out of Stock
                Items
              </h6>
              <h3 class="text-danger">{{ metrics().zeroStockCount }}</h3>
              <p class="text-muted mb-0">Items requiring immediate reorder</p>
              @if (metrics().zeroStockCount > 0) {
                <button
                  class="btn btn-outline-danger btn-sm mt-2"
                  (click)="setView('zero')"
                >
                  View Critical Items
                </button>
              }
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="card-title text-warning">
                <i class="fas fa-exclamation-circle me-2"></i>Low Stock Items
              </h6>
              <h3 class="text-warning">{{ metrics().lowStockCount }}</h3>
              <p class="text-muted mb-0">Items below minimum threshold</p>
              @if (metrics().lowStockCount > 0) {
                <button
                  class="btn btn-outline-warning btn-sm mt-2"
                  (click)="setView('low')"
                >
                  Plan Reorders
                </button>
              }
            </div>
          </div>
        </div>

        <div class="col-md-4 mb-3">
          <div class="card border-0 shadow-sm">
            <div class="card-body">
              <h6 class="card-title text-info">
                <i class="fas fa-info-circle me-2"></i>Overstock Items
              </h6>
              <h3 class="text-info">{{ metrics().overStockCount }}</h3>
              <p class="text-muted mb-0">Items above maximum threshold</p>
              @if (metrics().overStockCount > 0) {
                <button
                  class="btn btn-outline-info btn-sm mt-2"
                  (click)="setView('over')"
                >
                  Consider Promotions
                </button>
              }
            </div>
          </div>
        </div>
      </div>
    }

    <!-- Stock List Views -->
    @if (selectedView() !== "dashboard") {
      <!-- Filters and Search -->
      <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <label for="search" class="form-label">Search Products</label>
              <div class="input-group">
                <span class="input-group-text">
                  <i class="fas fa-search"></i>
                </span>
                <input
                  type="text"
                  class="form-control"
                  id="search"
                  placeholder="Search by product name, code, or warehouse..."
                  [value]="searchTerm()"
                  (input)="searchTerm.set($any($event.target).value)"
                />
              </div>
            </div>
            <div class="col-md-6">
              <label for="warehouse" class="form-label"
                >Filter by Warehouse</label
              >
              <select
                class="form-select"
                id="warehouse"
                [value]="selectedWarehouse()"
                (change)="selectedWarehouse.set($any($event.target).value)"
              >
                <option value="all">All Warehouses</option>
                @for (warehouse of warehouses(); track warehouse.uuid) {
                  <option [value]="warehouse.uuid">
                    {{ warehouse.name }} ({{ warehouse.code }})
                  </option>
                }
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Stock Table -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
          <h5 class="mb-0">
            @if (selectedView() === "all") {
              <i class="fas fa-list me-2"></i>All Stock Items
            } @else if (selectedView() === "low") {
              <i class="fas fa-exclamation-circle me-2 text-warning"></i>Low
              Stock Items
            } @else if (selectedView() === "zero") {
              <i class="fas fa-exclamation-triangle me-2 text-danger"></i>Out of
              Stock Items
            } @else if (selectedView() === "over") {
              <i class="fas fa-info-circle me-2 text-info"></i>Overstock Items
            }
            <span class="badge bg-secondary ms-2">{{
              filteredStocks().length
            }}</span>
          </h5>
        </div>
        <div class="card-body p-0">
          @if (filteredStocks().length === 0) {
            <div class="text-center py-5">
              <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">No Stock Items Found</h5>
              <p class="text-muted">
                @if (searchTerm() || selectedWarehouse() !== "all") {
                  Try adjusting your search criteria or filters.
                } @else {
                  No stock items match the current view.
                }
              </p>
            </div>
          } @else {
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light">
                  <tr>
                    <th scope="col">Status</th>
                    <th scope="col">Product</th>
                    <th scope="col">Warehouse</th>
                    <th scope="col">Current Stock</th>
                    <th scope="col">Stock Levels</th>
                    <th scope="col">Last Updated</th>
                    <th scope="col">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (stock of filteredStocks(); track stock.uuid) {
                    <tr>
                      <!-- Status -->
                      <td>
                        <i
                          [class]="
                            getStockStatusIcon(stock) +
                            ' ' +
                            getStockStatusClass(stock)
                          "
                        ></i>
                      </td>

                      <!-- Product -->
                      <td>
                        <div>
                          <strong>{{ stock.productName }}</strong>
                          <br />
                          <small class="text-muted">{{
                            stock.productCode
                          }}</small>
                        </div>
                      </td>

                      <!-- Warehouse -->
                      <td>
                        <div>
                          <span class="fw-medium">{{
                            stock.warehouseName
                          }}</span>
                          <br />
                          <small class="text-muted">{{
                            stock.warehouseCode
                          }}</small>
                        </div>
                      </td>

                      <!-- Current Stock -->
                      <td>
                        <span
                          class="badge fs-6"
                          [class.bg-danger]="stock.quantity === 0"
                          [class.bg-warning]="
                            stock.minStockLevel &&
                            stock.quantity <= stock.minStockLevel &&
                            stock.quantity > 0
                          "
                          [class.bg-info]="
                            stock.maxStockLevel &&
                            stock.quantity >= stock.maxStockLevel
                          "
                          [class.bg-success]="
                            stock.quantity > 0 &&
                            (!stock.minStockLevel ||
                              stock.quantity > stock.minStockLevel) &&
                            (!stock.maxStockLevel ||
                              stock.quantity < stock.maxStockLevel)
                          "
                        >
                          {{ stock.quantity }}
                        </span>
                      </td>

                      <!-- Stock Levels -->
                      <td>
                        <small class="text-muted">
                          @if (stock.minStockLevel) {
                            Min: {{ stock.minStockLevel }}
                          }
                          @if (stock.minStockLevel && stock.maxStockLevel) {
                            <br />
                          }
                          @if (stock.maxStockLevel) {
                            Max: {{ stock.maxStockLevel }}
                          }
                          @if (!stock.minStockLevel && !stock.maxStockLevel) {
                            Not set
                          }
                        </small>
                      </td>

                      <!-- Last Updated -->
                      <td>
                        <small class="text-muted">
                          {{ formatDate(stock.lastUpdated) }}
                        </small>
                      </td>

                      <!-- Actions -->
                      <td>
                        <div class="btn-group btn-group-sm" role="group">
                          <button
                            type="button"
                            class="btn btn-outline-success"
                            (click)="addStock(stock.uuid, 10)"
                            title="Add 10 units"
                          >
                            <i class="fas fa-plus"></i>
                          </button>
                          <button
                            type="button"
                            class="btn btn-outline-danger"
                            (click)="removeStock(stock.uuid, 5)"
                            [disabled]="stock.quantity < 5"
                            title="Remove 5 units"
                          >
                            <i class="fas fa-minus"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>
    }
  }
</div>
